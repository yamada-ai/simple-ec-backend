package com.example.ec.integration

import com.example.ec.integration.helper.SqlTestHelper
import io.kotest.core.spec.style.FunSpec
import io.kotest.matchers.shouldBe
import io.kotest.matchers.shouldNotBe
import org.springframework.boot.test.autoconfigure.jdbc.AutoConfigureTestDatabase
import org.springframework.boot.test.context.SpringBootTest
import org.springframework.boot.test.web.client.TestRestTemplate
import org.springframework.boot.test.web.client.getForEntity
import org.springframework.http.HttpStatus
import org.springframework.jdbc.core.JdbcTemplate
import org.springframework.test.context.DynamicPropertyRegistry
import org.springframework.test.context.DynamicPropertySource
import org.testcontainers.containers.PostgreSQLContainer
import org.testcontainers.junit.jupiter.Container
import org.testcontainers.junit.jupiter.Testcontainers

/**
 * FIXME: TestContainers が WSL2 環境でDocker環境を見つけられない問題により一旦無効化
 * Issue を別途作成して対応する
 *
 * 必要な環境変数:
 * - DOCKER_HOST=unix:///var/run/docker.sock
 * - TESTCONTAINERS_DOCKER_SOCKET_OVERRIDE=/var/run/docker.sock
 */
@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)
@AutoConfigureTestDatabase(replace = AutoConfigureTestDatabase.Replace.NONE)
@Testcontainers
@org.junit.jupiter.api.Disabled("TestContainers Docker environment issue on WSL2")
class OrdersApiIntegrationTest(
    private val restTemplate: TestRestTemplate,
    private val jdbcTemplate: JdbcTemplate
) : FunSpec({

    beforeEach {
        // Clean all tables before each test
        SqlTestHelper.executeSqlFile(jdbcTemplate, "sql/rollback.sql")
    }

    test("GET /api/orders/{orderId} should return order detail with customer and items") {
        // Setup: Load test data
        SqlTestHelper.executeSqlFile(jdbcTemplate, "sql/order-detail-test-data.sql")

        // Execute: Call API
        val response = restTemplate.getForEntity<Map<String, Any>>("/api/orders/1")

        // Verify: Response status
        response.statusCode shouldBe HttpStatus.OK

        // Verify: Response body structure
        val body = response.body
        body shouldNotBe null
        body!!["id"] shouldBe 1

        // Verify: Customer info
        @Suppress("UNCHECKED_CAST")
        val customer = body["customer"] as Map<String, Any>
        customer["id"] shouldBe 1
        customer["name"] shouldBe "Test Customer"
        customer["email"] shouldBe "test@example.com"

        // Verify: Order info
        body["totalAmount"] shouldBe 3500.0

        // Verify: Order items
        @Suppress("UNCHECKED_CAST")
        val items = body["items"] as List<Map<String, Any>>
        items.size shouldBe 2

        items[0]["id"] shouldBe 1
        items[0]["productName"] shouldBe "Laptop"
        items[0]["quantity"] shouldBe 1
        items[0]["unitPrice"] shouldBe 2500.0

        items[1]["id"] shouldBe 2
        items[1]["productName"] shouldBe "Mouse"
        items[1]["quantity"] shouldBe 2
        items[1]["unitPrice"] shouldBe 500.0
    }

    test("GET /api/orders/{orderId} should return 404 when order does not exist") {
        // Execute: Call API with non-existent order ID
        val response = restTemplate.getForEntity<String>("/api/orders/999")

        // Verify: Response status
        response.statusCode shouldBe HttpStatus.NOT_FOUND
    }

}) {
    companion object {
        @Container
        private val postgresContainer = PostgreSQLContainer<Nothing>("postgres:17").apply {
            withDatabaseName("simple_ec_test")
            withUsername("test")
            withPassword("test")
        }

        @JvmStatic
        @DynamicPropertySource
        fun registerProperties(registry: DynamicPropertyRegistry) {
            postgresContainer.start()
            registry.add("spring.datasource.url", postgresContainer::getJdbcUrl)
            registry.add("spring.datasource.username", postgresContainer::getUsername)
            registry.add("spring.datasource.password", postgresContainer::getPassword)
            registry.add("spring.flyway.url", postgresContainer::getJdbcUrl)
            registry.add("spring.flyway.user", postgresContainer::getUsername)
            registry.add("spring.flyway.password", postgresContainer::getPassword)
        }
    }
}
