openapi: 3.0.3
info:
  title: Simple EC Backend API
  description: |
    A simple e-commerce backend for comparing Stream/Sequence performance in 1-to-many data export.
    This project is an experimental repository for Advent Calendar article.
  version: 0.0.1
servers:
  - url: http://localhost:8080
    description: Local development server

tags:
  - name: customers
    description: Customer management
  - name: orders
    description: Order management
  - name: attributes
    description: Order attribute definition management
  - name: export
    description: CSV export endpoints
  - name: admin
    description: Admin endpoints for data management (development/testing only)

paths:
  # Attribute Definition endpoints
  /api/attribute-definitions:
    get:
      tags:
        - attributes
      summary: Get all attribute definitions
      description: Get list of all order attribute definitions
      operationId: listAttributeDefinitions
      responses:
        '200':
          description: Success
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/AttributeDefinitionResponse'
    post:
      tags:
        - attributes
      summary: Create a new attribute definition
      operationId: createAttributeDefinition
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateAttributeDefinitionRequest'
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AttributeDefinitionResponse'

  /api/attribute-definitions/{id}:
    get:
      tags:
        - attributes
      summary: Get attribute definition by ID
      operationId: getAttributeDefinition
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
            format: int64
      responses:
        '200':
          description: Success
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AttributeDefinitionResponse'
        '404':
          description: Attribute definition not found
    put:
      tags:
        - attributes
      summary: Update attribute definition
      operationId: updateAttributeDefinition
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
            format: int64
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateAttributeDefinitionRequest'
      responses:
        '200':
          description: Success
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AttributeDefinitionResponse'
    delete:
      tags:
        - attributes
      summary: Delete attribute definition
      description: Delete attribute definition and all associated values (CASCADE)
      operationId: deleteAttributeDefinition
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
            format: int64
      responses:
        '204':
          description: No content

  /api/orders/{orderId}:
    get:
      tags:
        - orders
      summary: Get order detail by ID
      description: Get order with customer information and order items
      operationId: getOrderDetail
      parameters:
        - name: orderId
          in: path
          required: true
          schema:
            type: integer
            format: int64
      responses:
        '200':
          description: Success
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrderDetailResponse'
        '404':
          description: Order not found
    put:
      tags:
        - orders
      summary: Update order
      operationId: updateOrder
      parameters:
        - name: orderId
          in: path
          required: true
          schema:
            type: integer
            format: int64
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/OrderRequest'
      responses:
        '200':
          description: Success
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrderResponse'
    delete:
      tags:
        - orders
      summary: Delete order
      operationId: deleteOrder
      parameters:
        - name: orderId
          in: path
          required: true
          schema:
            type: integer
            format: int64
      responses:
        '204':
          description: No content

  # Customer endpoints
  /api/customers:
    get:
      tags:
        - customers
      summary: Get all customers
      operationId: getCustomers
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            default: 0
        - name: size
          in: query
          schema:
            type: integer
            default: 20
      responses:
        '200':
          description: Success
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/CustomerResponse'
    post:
      tags:
        - customers
      summary: Create a new customer
      operationId: createCustomer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CustomerRequest'
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CustomerResponse'

  /api/customers/{customerId}:
    get:
      tags:
        - customers
      summary: Get customer by ID
      operationId: getCustomer
      parameters:
        - name: customerId
          in: path
          required: true
          schema:
            type: integer
            format: int64
      responses:
        '200':
          description: Success
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CustomerResponse'
        '404':
          description: Customer not found
    put:
      tags:
        - customers
      summary: Update customer
      operationId: updateCustomer
      parameters:
        - name: customerId
          in: path
          required: true
          schema:
            type: integer
            format: int64
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CustomerRequest'
      responses:
        '200':
          description: Success
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CustomerResponse'
    delete:
      tags:
        - customers
      summary: Delete customer
      operationId: deleteCustomer
      parameters:
        - name: customerId
          in: path
          required: true
          schema:
            type: integer
            format: int64
      responses:
        '204':
          description: No content

  # Order endpoints
  /api/orders:
    get:
      tags:
        - orders
      summary: Get orders with pagination and filtering
      description: Get paginated list of orders with optional filtering by date range and customer name
      operationId: getOrders
      parameters:
        - name: from
          in: query
          description: Filter orders from this date (ISO 8601 format)
          schema:
            type: string
            format: date-time
        - name: to
          in: query
          description: Filter orders until this date (ISO 8601 format)
          schema:
            type: string
            format: date-time
        - name: customerName
          in: query
          description: Filter by customer name (partial match)
          schema:
            type: string
        - name: page
          in: query
          description: Page number (0-indexed)
          schema:
            type: integer
            default: 0
            minimum: 0
        - name: size
          in: query
          description: Page size
          schema:
            type: integer
            default: 20
            minimum: 1
            maximum: 100
      responses:
        '200':
          description: Success
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PagedOrderListResponse'
    post:
      tags:
        - orders
      summary: Create a new order
      operationId: createOrder
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/OrderRequest'
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrderResponse'

  # Export endpoint (main experimental feature)
  /api/export/orders:
    get:
      tags:
        - export
      summary: Export orders with items as CSV (streaming)
      description: |
        Export orders with their items in CSV format.
        This endpoint is used to compare Kotlin Sequence vs Java Stream vs custom Spliterator
        for handling 1-to-many data expansion.
      operationId: exportOrders
      parameters:
        - name: startDate
          in: query
          required: false
          schema:
            type: string
            format: date-time
        - name: endDate
          in: query
          required: false
          schema:
            type: string
            format: date-time
        - name: strategy
          in: query
          description: Export strategy (sequence/stream-flatmap/stream-mapmulti/spliterator)
          required: false
          schema:
            type: string
            enum:
              - sequence
              - stream-flatmap
              - stream-mapmulti
              - spliterator
            default: sequence
      responses:
        '200':
          description: CSV file
          content:
            text/csv:
              schema:
                type: string
                format: binary

  # Admin endpoints
  /admin/summary:
    get:
      tags:
        - admin
      summary: Get data summary
      description: Get count of customers, orders, and order items for development/testing
      operationId: getAdminSummary
      responses:
        '200':
          description: Success
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AdminSummaryResponse'

  /admin/seed:
    post:
      tags:
        - admin
      summary: Seed test data
      description: Generate test data for development/testing. Use seed parameter for reproducible data generation.
      operationId: seedData
      parameters:
        - name: customers
          in: query
          description: Number of customers to generate
          schema:
            type: integer
            default: 100
            minimum: 1
            maximum: 10000
        - name: orders
          in: query
          description: Number of orders to generate
          schema:
            type: integer
            default: 1000
            minimum: 1
            maximum: 100000
        - name: attrs
          in: query
          description: Number of attribute definitions to generate (0 = no attributes)
          schema:
            type: integer
            default: 0
            minimum: 0
            maximum: 100
        - name: seed
          in: query
          description: Random seed for reproducible data generation (optional, random if not specified)
          schema:
            type: integer
            format: int64
      responses:
        '200':
          description: Success
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SeedDataResponse'

  /admin/truncate:
    delete:
      tags:
        - admin
      summary: Truncate all data
      description: Delete all customers, orders, and order items (does not delete order attributes)
      operationId: truncateData
      responses:
        '200':
          description: Success
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TruncateDataResponse'

components:
  schemas:
    # Order Detail API schemas
    OrderDetailResponse:
      type: object
      required:
        - id
        - customer
        - orderDate
        - totalAmount
        - items
        - createdAt
      properties:
        id:
          type: integer
          format: int64
        customer:
          $ref: '#/components/schemas/CustomerSummary'
        orderDate:
          type: string
          format: date-time
        totalAmount:
          type: number
          format: double
        items:
          type: array
          items:
            $ref: '#/components/schemas/OrderItemSummary'
        createdAt:
          type: string
          format: date-time

    # Order List API schemas
    PagedOrderListResponse:
      type: object
      required:
        - content
        - page
        - size
        - totalPages
        - totalElements
      properties:
        content:
          type: array
          items:
            $ref: '#/components/schemas/OrderListResponse'
        page:
          type: integer
          description: Current page number (0-indexed)
        size:
          type: integer
          description: Page size
        totalPages:
          type: integer
          description: Total number of pages
        totalElements:
          type: integer
          format: int64
          description: Total number of elements

    OrderListResponse:
      type: object
      required:
        - id
        - customerName
        - orderDate
        - totalAmount
        - itemCount
      properties:
        id:
          type: integer
          format: int64
        customerName:
          type: string
          description: Customer name
        orderDate:
          type: string
          format: date-time
        totalAmount:
          type: number
          format: double
        itemCount:
          type: integer
          description: Number of items in the order

    CustomerSummary:
      type: object
      required:
        - id
        - name
        - email
      properties:
        id:
          type: integer
          format: int64
        name:
          type: string
        email:
          type: string

    OrderItemSummary:
      type: object
      required:
        - id
        - productName
        - quantity
        - unitPrice
      properties:
        id:
          type: integer
          format: int64
        productName:
          type: string
        quantity:
          type: integer
        unitPrice:
          type: number
          format: double

    CustomerRequest:
      type: object
      required:
        - name
        - email
      properties:
        name:
          type: string
          maxLength: 100
        email:
          type: string
          format: email
          maxLength: 255

    CustomerResponse:
      type: object
      properties:
        id:
          type: integer
          format: int64
        name:
          type: string
        email:
          type: string
        createdAt:
          type: string
          format: date-time

    OrderRequest:
      type: object
      required:
        - customerId
        - totalAmount
      properties:
        customerId:
          type: integer
          format: int64
        totalAmount:
          type: number
          format: decimal
        items:
          type: array
          items:
            $ref: '#/components/schemas/OrderItemRequest'

    OrderResponse:
      type: object
      properties:
        id:
          type: integer
          format: int64
        customerId:
          type: integer
          format: int64
        orderDate:
          type: string
          format: date-time
        totalAmount:
          type: number
          format: decimal
        createdAt:
          type: string
          format: date-time
        items:
          type: array
          items:
            $ref: '#/components/schemas/OrderItemSummary'

    OrderItemRequest:
      type: object
      required:
        - productName
        - quantity
        - unitPrice
      properties:
        productName:
          type: string
          maxLength: 255
        quantity:
          type: integer
          minimum: 1
        unitPrice:
          type: number
          format: decimal
          minimum: 0

    # Admin API schemas
    AdminSummaryResponse:
      type: object
      required:
        - customers
        - orders
        - orderItems
        - attributeDefinitions
      properties:
        customers:
          type: integer
          format: int64
          description: Total number of customers
        orders:
          type: integer
          format: int64
          description: Total number of orders
        orderItems:
          type: integer
          format: int64
          description: Total number of order items
        attributeDefinitions:
          type: integer
          format: int64
          description: Total number of attribute definitions

    SeedDataResponse:
      type: object
      required:
        - customersCreated
        - ordersCreated
        - orderItemsCreated
        - attributeDefinitionsCreated
        - attributeValuesCreated
      properties:
        customersCreated:
          type: integer
          description: Number of customers created
        ordersCreated:
          type: integer
          description: Number of orders created
        orderItemsCreated:
          type: integer
          description: Number of order items created
        attributeDefinitionsCreated:
          type: integer
          description: Number of attribute definitions created
        attributeValuesCreated:
          type: integer
          description: Number of attribute values created

    TruncateDataResponse:
      type: object
      required:
        - deleted
        - message
      properties:
        deleted:
          type: boolean
          description: Whether data was successfully deleted
        message:
          type: string
          description: Result message

    # Attribute Definition API schemas
    AttributeDefinitionResponse:
      type: object
      required:
        - id
        - name
        - label
        - createdAt
      properties:
        id:
          type: integer
          format: int64
        name:
          type: string
          description: Internal name (unique)
        label:
          type: string
          description: Display label
        description:
          type: string
          nullable: true
        createdAt:
          type: string
          format: date-time

    CreateAttributeDefinitionRequest:
      type: object
      required:
        - name
        - label
      properties:
        name:
          type: string
          maxLength: 100
          description: Internal name (unique, e.g., gift_wrapping_type)
        label:
          type: string
          maxLength: 100
          description: Display label (e.g., Gift Wrapping Type)
        description:
          type: string
          maxLength: 255
          nullable: true

    UpdateAttributeDefinitionRequest:
      type: object
      required:
        - name
        - label
      properties:
        name:
          type: string
          maxLength: 100
          description: Internal name (unique)
        label:
          type: string
          maxLength: 100
          description: Display label
        description:
          type: string
          maxLength: 255
          nullable: true
